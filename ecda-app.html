﻿
<dom-module id="ecda-app">


    <link rel="import" href="bower_components/iron-icons/iron-icons.html">

    <link rel="import"
          href="bower_components/paper-drawer-panel/paper-drawer-panel.html">
    <link rel="import"
          href="bower_components/paper-header-panel/paper-header-panel.html">
    <link rel="import"
          href="bower_components/paper-icon-button/paper-icon-button.html">
    <link rel="import" href="bower_components/paper-item/paper-item.html">
    <link rel="import" href="bower_components/paper-menu/paper-menu.html">
    <link rel="import" href="bower_components/paper-toolbar/paper-toolbar.html">

    <link rel="import" href="bower_components/paper-spinner/paper-spinner.html">


    <link rel="import" href="ecda-container2.html"/>


    <link rel="import" type="css" href="stylesheets/ecda.css"/>

    <template>

        <paper-dialog id="modal" modal>
            <paper-input value="zpq4@cdc.gov" label="email" id="email">
                <iron-icon icon="mail" prefix></iron-icon>
            </paper-input>
            <paper-input value="Welcome!44" label="password" id="password"
                         type="password">
                <iron-icon icon="card-membership" prefix></iron-icon>
            </paper-input>
            <div class="buttons">
                <paper-button dialog-confirm autofocus on-click="okClick">OK
                    dokey
                </paper-button>
                <paper-button dialog-cancel autofocus>7777</paper-button>
            </div>
        </paper-dialog>


        <app-location route="{{route}}" use-hash-as-path></app-location>

        <app-route route="{{route}}">
            pattern="/:action"
            data="{{actionData}}"
            tail="{{actionTail}}"
        </app-route>


        <iron-ajax id="myAjax" on-response="handleResponse"></iron-ajax>
        <iron-ajax id="canvasAjax"
                   on-response="handleCanvasResponse"></iron-ajax>
        <iron-ajax id="canvasListAjax"
                   on-response="handleCanvasListResponse"></iron-ajax>


        <style>
            .appTitle {
                border: white;
                text-align: right;
                width: 100%;
            }
        </style>


        <paper-drawer-panel id="mainDrawerPanel" class="main-drawer-panel"
                            main
                            drawer-toggle-attribute="list-toggle">

            <paper-header-panel class="list-panel"
                                on-content-scroll="scrollHandler" drawer>

                <!-- List Toolbar -->
                <paper-toolbar>
                    <paper-icon-button icon="home"
                                       list-toggle></paper-icon-button>
                </paper-toolbar>

                <!-- List -->
                <paper-menu class="list" on-iron-activate="_listTap">
                    <paper-item>FFFF</paper-item>
                    <paper-item></paper-item>
                    <paper-item></paper-item>
                    <paper-item></paper-item>
                    <paper-item></paper-item>
                    <paper-item></paper-item>
                    <paper-item></paper-item>
                    <paper-item></paper-item>
                    <paper-item></paper-item>
                    <paper-item></paper-item>
                    <paper-item></paper-item>
                    <paper-item></paper-item>
                    <paper-item></paper-item>
                    <paper-item></paper-item>
                    <paper-item></paper-item>
                    <paper-item></paper-item>
                    <paper-item></paper-item>
                    <paper-item></paper-item>
                    <paper-item></paper-item>
                    <paper-item></paper-item>
                </paper-menu>

            </paper-header-panel>

            <paper-header-panel class="list-panel"
                                on-content-scroll="scrollHandler" main>

                <!-- Main Toolbar -->
                <paper-toolbar>
                    <paper-icon-button icon="menu"
                                       list-toggle></paper-icon-button>
                    <paper-icon-button icon="save"
                    ></paper-icon-button>

                </paper-toolbar>

                <!-- Main Content -->
                <div class="content">

                    <paper-spinner   id="pleasewait"></paper-spinner>
                    <ecda-container2 id="ecda_cont"
                                     gadgets-collection="{{canvasResponseJson}}">

                    </ecda-container2>
                </div>


            </paper-header-panel>

        </paper-drawer-panel>

    </template>

    <script>


        Polymer({
            is: 'ecda-app',
            properties: {
                canvasResponseJson: {
                    type: Object,
                    notify: true

                }
            },
            ready: function () {

                /*       var user = tempConstants.user;
                 var password = tempConstants.password;
                 var canvasid = tempConstants.canvasid;

                 var jsonRequest = {
                 id: user,
                 password: password,
                 canvasid: canvasid
                 };


                 logThis('ready from app  ');

                 tryAjax(this.$.myAjax, "Login", jsonRequest);

                 */
            },
            okClick: function () {
                this._logonUser();
            },
            _logonUser: function () {
                var user = this.$.email.value;
                var password = this.$.password.value;
                var canvasid = tempConstants.canvasid;

                var jsonRequest = {
                    id: user,
                    password: password,
                    canvasid: canvasid
                };


                logThis('ready from app  ');

                this.$.pleasewait.active = true;

                tryAjax(this.$.myAjax, "Login", jsonRequest);


            },
            _computeListWidth: function (isMobile) {
                // when in mobile screen size, make the list be 100% width to cover the whole screen
                return isMobile ? '100%' : '33%';
            },
            _listTap: function () {
                this.$.mainDrawerPanel.closeDrawer();
            },
            handleCanvasResponse: function (response) {

                this.$.pleasewait.active = false;

                this.canvasResponseJson = JSON.parse(response.detail.xhr.responseText);
                //  this.$.ecda_cont.gadgetsCollection = this.canvasResponseJson;


            },
            handleResponse: function (e, responseX) {


                logThis("e.detail.xhr.responseType  --> " + e.detail.xhr.responseType);


                logThis(e.detail.xhr.responseText);

                var responseJson = JSON.parse(e.detail.xhr.responseText);


                if (gUserJson) {

                    gUserJson.User = responseJson;
                    console.log('cont gUser ---->  ' + gUserJson.User);

                    walk(gUserJson, "gUserJson");

                }

                //======================
                var user = gUserJson.User.Email;
                var password = gUserJson.User.PasswordHash;
                var canvasid = tempConstants.canvasid;

                var jsonUser = {
                    id: user,
                    password: password,
                    canvasid: canvasid
                };


                tryAjax(this.$.canvasAjax, "Canvas", jsonUser);

                logThis(this.$.canvasAjax.body);
            },
            scrollHandler: function (event) {
                var scroller = event.detail.target;
                logThis(scroller.scrollTop);
            }
        });
    </script>

</dom-module>